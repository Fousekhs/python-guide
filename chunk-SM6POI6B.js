import{g as P,h as R,i as k,j as u,k as $,n as l,q as m,s as o,t as A,u as x,v as f}from"./chunk-ZCTLOLTJ.js";import{$ as y,S,da as O,o as c,u as d}from"./chunk-PT7SL42D.js";import{a,b as p}from"./chunk-WTI2L5DI.js";var D=class j{constructor(t){this.db=t}nextOrder(t){let e=k(o(this.db,t),R("order"),P(1));return c(l(e)).pipe(d(r=>{if(!r.exists())return 0;let s=-1;return r.forEach(n=>{let i=n.val();typeof i?.order=="number"&&i.order>s&&(s=i.order)}),s+1}))}sortByOrder(t){return t.sort((e,r)=>e.order-r.order)}createSection(t){let e="sections",r=o(this.db,e);return this.nextOrder(e).pipe(S(s=>{let n=m(r),i=p(a({},t),{id:n.key,order:s,createdAt:u(),updatedAt:u(),publishedAt:t.isPublished?u():null});return c(x(n,i)).pipe(d(()=>n.key))}))}updateSection(t,e){let r=o(this.db,`sections/${t}`),s=a(a(p(a({},e),{updatedAt:u()}),e.isPublished===!0?{publishedAt:u()}:{}),e.isPublished===!1?{publishedAt:null}:{});return c(f(r,s))}deleteSection(t){let e=o(this.db,`sections/${t}`);return c(A(e))}getSection(t){let e=o(this.db,`sections/${t}`);return c(l(e)).pipe(d(r=>{if(!r.exists())return null;let s=r.val(),n=[];return s.subjects&&Object.keys(s.subjects).forEach(i=>{let b=s.subjects[i],g=[];b.contents&&Object.keys(b.contents).forEach(h=>{let v=b.contents[h];v.type&&g.push(a({id:h},v))}),n.push(p(a({id:i},b),{contents:this.sortByOrder(g)}))}),p(a({id:t},s),{subjects:this.sortByOrder(n)})}))}getAllSections(){let t=o(this.db,"sections");return c(l(t)).pipe(d(e=>{if(!e.exists())return[];let r=[];return e.forEach(s=>{let n=s.val(),i=[];return n.subjects&&Object.keys(n.subjects).forEach(b=>{let g=n.subjects[b],h=[];g.contents&&Object.keys(g.contents).forEach(v=>{let C=g.contents[v];C.type&&h.push(a({id:v},C))}),i.push(p(a({id:b},g),{contents:this.sortByOrder(h)}))}),r.push(p(a({id:s.key},n),{subjects:this.sortByOrder(i)})),!1}),this.sortByOrder(r)}))}getPublishedSections(){return this.getAllSections().pipe(d(t=>t.filter(e=>e.isPublished)))}publishSection(t){return this.updateSection(t,{isPublished:!0})}unpublishSection(t){return this.updateSection(t,{isPublished:!1})}reorderSections(t){let e={};return t.forEach((r,s)=>{r?.id&&(e[`sections/${r.id}/order`]=s,e[`sections/${r.id}/updatedAt`]=u())}),c(f(o(this.db),e))}createSubject(t,e){let r=`sections/${t}/subjects`;return this.nextOrder(r).pipe(S(s=>{let n=m(o(this.db,r)),i=p(a({},e),{id:n.key,sectionId:t,order:s,createdAt:u(),updatedAt:u()});return c(x(n,i)).pipe(d(()=>n.key))}))}updateSubject(t,e,r){let s=o(this.db,`sections/${t}/subjects/${e}`),n=p(a({},r),{updatedAt:u()});return c(f(s,n))}deleteSubject(t,e){let r=o(this.db,`sections/${t}/subjects/${e}`);return c(A(r))}getSubject(t,e){let r=o(this.db,`sections/${t}/subjects/${e}`);return c(l(r)).pipe(d(s=>{if(!s.exists())return null;let n=s.val(),i=[];return n.contents&&Object.keys(n.contents).forEach(b=>{let g=n.contents[b];g.type&&i.push(a({id:b},g))}),p(a({id:e},n),{contents:this.sortByOrder(i)})}))}getSubjectsBySectionId(t){let e=o(this.db,`sections/${t}/subjects`);return c(l(e)).pipe(d(r=>{if(!r.exists())return[];let s=[];return r.forEach(n=>{let i=n.val(),b=[];return i.contents&&Object.keys(i.contents).forEach(g=>{let h=i.contents[g];h.type&&b.push(a({id:g},h))}),s.push(p(a({id:n.key},i),{contents:this.sortByOrder(b)})),!1}),this.sortByOrder(s)}))}reorderSubjects(t,e){let r={};return e.forEach((s,n)=>{s?.id&&(r[`sections/${t}/subjects/${s.id}/order`]=n,r[`sections/${t}/subjects/${s.id}/updatedAt`]=u())}),c(f(o(this.db),r))}addContentToSubject(t,e,r){let s=`sections/${t}/subjects/${e}/contents`;return this.nextOrder(s).pipe(S(n=>{let i=m(o(this.db,s)),b=p(a({},r),{id:i.key,order:n,createdAt:u(),updatedAt:u()});return c(x(i,b)).pipe(d(()=>i.key))}))}updateSubjectContent(t,e,r,s){let n=o(this.db,`sections/${t}/subjects/${e}/contents/${r}`),i=p(a({},s),{updatedAt:u()});return c(f(n,i))}deleteSubjectContent(t,e,r){let s=o(this.db,`sections/${t}/subjects/${e}/contents/${r}`);return c(A(s))}getSubjectContent(t,e,r){let s=o(this.db,`sections/${t}/subjects/${e}/contents/${r}`);return c(l(s)).pipe(d(n=>n.exists()?a({id:n.key},n.val()):null))}getSubjectContents(t,e){let r=o(this.db,`sections/${t}/subjects/${e}/contents`);return c(l(r)).pipe(d(s=>{if(!s.exists())return[];let n=[];return s.forEach(i=>{let b=i.val();return b.type&&n.push(a({id:i.key},b)),!1}),this.sortByOrder(n)}))}reorderSubjectContent(t,e,r){let s={};return r.forEach((n,i)=>{n?.id&&(s[`sections/${t}/subjects/${e}/contents/${n.id}/order`]=i,s[`sections/${t}/subjects/${e}/contents/${n.id}/updatedAt`]=u())}),c(f(o(this.db),s))}static \u0275fac=function(e){return new(e||j)(O($))};static \u0275prov=y({token:j,factory:j.\u0275fac,providedIn:"root"})};var B=class j{constructor(t){this.db=t}getUserData(t){let e=o(this.db,`users/${t}`);return c(l(e)).pipe(d(r=>r.exists()?a({uid:t},r.val()):null))}promoteUser(t,e){let r=m(o(this.db,"adminAudit")).key,s={};return s[`roles/admin/${t}`]=!0,s[`users/${t}/isAdmin`]=!0,s[`adminAudit/${r}`]={action:"promote",target:t,by:e,at:u()},c(f(o(this.db),s))}demoteUser(t,e){let r=m(o(this.db,"adminAudit")).key,s={};return s[`roles/admin/${t}`]=null,s[`users/${t}/isAdmin`]=!1,s[`adminAudit/${r}`]={action:"demote",target:t,by:e,at:u()},c(f(o(this.db),s))}getAllUsers(){return c(l(o(this.db,"users"))).pipe(d(t=>{if(!t.exists())return[];let e=[];return t.forEach(r=>(e.push(a({uid:r.key},r.val())),!1)),e.sort((r,s)=>(r.displayName??"").localeCompare(s.displayName??""))}))}getUserPoints(t){return c(l(o(this.db,`users/${t}/points`))).pipe(d(e=>e.exists()?e.val():0))}getSubjectProgress(t,e,r){let s=o(this.db,`users/${t}/progress/${e}/${r}`);return c(l(s)).pipe(d(n=>n.exists()?n.val():null))}setSubjectProgress(t,e,r,s){let n=o(this.db,`users/${t}/progress/${e}/${r}`);return c(f(n,p(a({},s),{updatedAt:u()})))}adjustTotalPoints(t,e){let r=o(this.db,`users/${t}`);return c(l(r)).pipe(S(s=>{let i=(s.exists()&&typeof s.val()?.points=="number"?s.val().points:0)+e;return c(f(r,{points:i,updatedAt:u()})).pipe(d(()=>i))}))}static \u0275fac=function(e){return new(e||j)(O($))};static \u0275prov=y({token:j,factory:j.\u0275fac,providedIn:"root"})};export{D as a,B as b};
