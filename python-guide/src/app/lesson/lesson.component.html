<div class="page-container">
    <header>
        <h2>Lesson 1: Python Basics</h2>
        <div class="space"></div>
        <button class="nav-button" (click)="goHome()">
            <span class="btn-label">Home</span> 
            <svg-home />
        </button>
    </header>

    <div class="lesson-container">
    @if (timeout) {
        <div class="timeout-message">
            <h3>Time's Up!</h3>
            <div>
                It seems you have run out of time :(<br>
                Don't worry you are going have another chance in the end!
            </div>
            <button class="next-button" (click)="goToNextLesson()">
                Next
            </button>
        </div>
    } @else if (finished) {
        <div class="finished-message">
            @if (!result) {
                Please wait...
            } @else {
                @if (isPractice) {
                    <div class="practice-results">
                        <h3>Practice Complete</h3>
                        <p>You have finished this {{practiceMode}} practice set.</p>
                        <div class="practice-gauge-container">
                          <div class="practice-echart-wrapper">
                            <echarts *ngIf="practiceGaugeOption" [options]="practiceGaugeOption" class="practice-chart"></echarts>
                            <div class="practice-gauge-label">Practice accuracy {{ practicePercent | number:'1.0-0' }}%</div>
                            @if (practicePercent <= 50) {
                                <div class="practice-gauge-subtext">Keep Practicing!</div>
                            } @else if (practicePercent > 50 && practicePercent < 75) {
                                <div class="practice-gauge-subtext">Almost there!</div>
                            } @else {
                                <div class="practice-gauge-subtext">Excellent!</div>                                
                            }    
                        </div>
                        </div>
                        <p class="disclaimer">These practice answers do not award points, do not change subject best scores, and are not shown on the leaderboard. They only help improve your personal stats for future practice selection.</p>
                        <div class="results-actions">
                          <button class="result-button" (click)="startAnotherPractice()">New {{practiceMode}} practice</button>
                          <button class="result-button" (click)="goHome()">Home</button>
                        </div>
                    </div>
                } @else if (retry) {
                    <div>
                        You have completed the lesson!<br>
                        Lets try again those questions you got wrong.
                    </div>
                    <button class="next-button" (click)="reviewIncorrectQuestions()">
                        Review Incorrect Questions
                    </button>
                } @else {
                    <div>
                        <app-results-visualization
                          [mastery]="mastery"
                          [efficiency]="efficiency"
                          [previousPoints]="previousPoints"
                          [newPoints]="newPoints"
                          [passed]="passedNow"
                          [sectionId]="sectionId"
                          [subjectId]="subjectId"
                          [leaderboardReady]="leaderboardReady">
                        </app-results-visualization>
                        <div class="results-actions">
                          <button class="result-button" (click)="retryLesson()">Retry</button>
                          <button class="result-button" (click)="goHome()">Home</button>
                        </div>
                    </div>
                }
            }
        </div>
    } @else {
        @switch (currentLesson.type) {
            @case ('theory') {
                <app-theory-unit [title]="currentLesson.title" [content]="currentLesson.content" (nextContent)="goToNextLesson()"></app-theory-unit>
            }
            @case ('truefalse') {
                <app-mcq-unit [title]="currentLesson.title" [availableTime]="currentLesson.timeLimitSeconds ?? 10" [isRetry]="retry" [userId]="userId" [sessionId]="sessionId" [sectionId]="sectionId" [subjectId]="subjectId" [questionId]="currentLesson.id ?? ''" [question]="currentLesson.question" [options]="trueFalseOptions" [correctAnswer]="getTrueFalseCorrectAnswer(currentLesson.correctAnswer)" (questionAnswered)="goToNextLesson()" (timeUp)="timeUp()"></app-mcq-unit>
            }
            @case ('mcq') {
                <app-mcq-unit [title]="currentLesson.title" [availableTime]="currentLesson.timeLimitSeconds ?? 10" [isRetry]="retry" [userId]="userId" [sessionId]="sessionId" [sectionId]="sectionId" [subjectId]="subjectId" [questionId]="currentLesson.id ?? ''" [question]="currentLesson.question" [options]="currentLesson.options" [correctAnswer]="currentLesson.correctAnswer" (questionAnswered)="goToNextLesson()" (timeUp)="timeUp()"></app-mcq-unit>
            }
            @default {
                <p class="error">
                    Something went wrong
                </p>
            }
        }
    }
    </div>

    @if (!timeout && !finished) {        
        <footer>
            <!-- <button class="nav-button" [disabled]="currentLessonIndex===0" (click)="goToPreviousLesson()">
                <svg-chevron-left />
                Previous
            </button> -->
            <capmax-progressbar [current]="currentLessonIndex+1" [total]="numberOfLessons"/>
            <!-- <button class="nav-button" [disabled]="(currentLessonIndex+1)===numberOfLessons" (click)="goToNextLesson()">
                Next
                <svg-chevron-right />
            </button> -->
        </footer>
    }
</div>