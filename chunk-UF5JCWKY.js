import{a as et,c as nt}from"./chunk-TXHZSW4H.js";import{p as rt}from"./chunk-TMDLGDPT.js";import{a as st}from"./chunk-U3LFEJY5.js";import{a as D,b as at}from"./chunk-SM6POI6B.js";import{w as ot}from"./chunk-ZCTLOLTJ.js";import{d as it}from"./chunk-FD3KUP4A.js";import{$,$a as b,Ab as C,Bb as F,Cb as X,Ea as s,Ja as A,Lb as E,Na as J,Nb as O,S as H,Tb as Y,_a as _,bb as G,cb as z,da as k,db as P,eb as o,fb as i,gb as M,hc as Z,ic as tt,ja as Q,ka as W,mb as q,nb as K,p as U,pb as L,ra as f,t as N,u as B,z as V,zb as a}from"./chunk-PT7SL42D.js";import{g as R}from"./chunk-WTI2L5DI.js";var T=class e{constructor(t,n,r){this.attempts=t;this.users=n;this.content=r}toEpoch(t){return typeof t=="number"?t:t&&typeof t=="object"&&"seconds"in t?t.seconds*1e3:Date.now()}getAggregated(t){return this.attempts.getSessionsForUser(t).pipe(H(n=>{let r=n.map(c=>({sessionId:c.id,sectionId:c.sectionId,subjectId:c.subjectId,mastery:c.mastery,efficiency:c.efficiency,pointsGained:c.pointsGained,startedAt:c.startedAt})),l={};n.forEach(c=>{let h=this.toEpoch(c.startedAt),x=new Date(h);x.setHours(0,0,0,0);let m=x.toISOString().substring(0,10);l[m]=(l[m]||0)+1});let g=Object.keys(l).map(c=>({date:c,count:l[c]})),u=0,j=[...n].sort((c,h)=>this.toEpoch(c.startedAt)-this.toEpoch(h.startedAt)).map(c=>(u+=c.pointsGained||0,{timestamp:this.toEpoch(c.startedAt),totalPoints:u}));return this.content.getAllSections().pipe(H(c=>{let h=[];c.forEach(m=>m.subjects.forEach(d=>h.push({sectionId:m.id,subject:d})));let x=h.map(m=>this.users.getSubjectProgress(t,m.sectionId,m.subject.id).pipe(B(d=>({sectionId:m.sectionId,subjectId:m.subject.id,progress:d}))));return(x.length?V(x):U([])).pipe(B(m=>{let d=0,I=[],y=[];m.forEach(v=>{v.progress?.passed&&(d++,typeof v.progress.lastEfficiency=="number"&&I.push(v.progress.lastEfficiency),typeof v.progress.lastMastery=="number"&&y.push(v.progress.lastMastery))});let w={avgBestEfficiency:I.length?I.reduce((v,S)=>v+S,0)/I.length:0,avgBestMastery:y.length?y.reduce((v,S)=>v+S,0)/y.length:0};return{perf:r,heatmap:g,pointsProgression:j,passedSubjects:{passed:d,total:h.length},averageBest:w}}))}),B(c=>{let h=n.filter(y=>y.mode==="random"),x=n.filter(y=>y.mode==="worst"),m=y=>{if(!y.length)return{average:0,history:[]};let w=y.map(S=>({sessionId:S.id,date:new Date(this.toEpoch(S.startedAt)).toISOString().substring(0,10),efficiency:S.efficiency,mastery:S.mastery,points:S.pointsGained}));return{average:w.reduce((S,dt)=>S+(dt.efficiency||0),0)/w.length,history:w}},d=m(h),I=m(x);return{subjectPerformances:c.perf,heatmap:c.heatmap,pointsProgression:c.pointsProgression,passedSubjects:c.passedSubjects,averageBest:c.averageBest,randomPractice:d,worstPractice:I}}))}))}static \u0275fac=function(n){return new(n||e)(k(st),k(at),k(D))};static \u0275prov=$({token:e,factory:e.\u0275fac,providedIn:"root"})};var lt=(e,t)=>t.sessionId;function ut(e,t){e&1&&M(0,"echarts",7),e&2&&P("options",t)}function ft(e,t){e&1&&(o(0,"p",8),a(1,"No activity yet."),i())}function _t(e,t){e&1&&M(0,"echarts",10),e&2&&P("options",t)}function bt(e,t){if(e&1&&(o(0,"div",11),a(1),i()),e&2){let n=t;s(),X("",n.passedSubjects.passed," / ",n.passedSubjects.total)}}function ht(e,t){e&1&&M(0,"echarts",13),e&2&&P("options",t)}function Ct(e,t){e&1&&(o(0,"p",8),a(1,"No data."),i())}function yt(e,t){e&1&&M(0,"echarts",13),e&2&&P("options",t)}function St(e,t){e&1&&(o(0,"p",8),a(1,"No data."),i())}function xt(e,t){e&1&&(o(0,"p"),a(1),E(2,"number"),i()),e&2&&(s(),F("Average Efficiency: ",O(2,1,t.randomPractice.average,"1.0-1"),"%"))}function vt(e,t){e&1&&M(0,"echarts",10),e&2&&P("options",t)}function Pt(e,t){if(e&1&&(o(0,"tr")(1,"td"),a(2),i(),o(3,"td"),a(4),i(),o(5,"td"),a(6),E(7,"number"),i(),o(8,"td"),a(9),E(10,"number"),i(),o(11,"td"),a(12),i()()),e&2){let n=t.$implicit;s(2),C(n.sessionId.substring(0,6)),s(2),C(n.date),s(2),C(O(7,5,n.efficiency||0,"1.0-1")),s(3),C(O(10,8,n.mastery||0,"1.0-1")),s(3),C(n.points||0)}}function Mt(e,t){e&1&&(o(0,"details",14)(1,"summary"),a(2,"Show History"),i(),o(3,"table",15)(4,"thead")(5,"tr")(6,"th"),a(7,"Session"),i(),o(8,"th"),a(9,"Date"),i(),o(10,"th"),a(11,"Eff%"),i(),o(12,"th"),a(13,"Mastery%"),i(),o(14,"th"),a(15,"Points"),i()()(),o(16,"tbody"),G(17,Pt,13,11,"tr",null,lt),i()()()),e&2&&(s(17),z(t.randomPractice.history))}function Et(e,t){e&1&&(o(0,"p"),a(1),E(2,"number"),i()),e&2&&(s(),F("Average Efficiency: ",O(2,1,t.worstPractice.average,"1.0-1"),"%"))}function Ot(e,t){e&1&&M(0,"echarts",10),e&2&&P("options",t)}function jt(e,t){if(e&1&&(o(0,"tr")(1,"td"),a(2),i(),o(3,"td"),a(4),i(),o(5,"td"),a(6),E(7,"number"),i(),o(8,"td"),a(9),E(10,"number"),i(),o(11,"td"),a(12),i()()),e&2){let n=t.$implicit;s(2),C(n.sessionId.substring(0,6)),s(2),C(n.date),s(2),C(O(7,5,n.efficiency||0,"1.0-1")),s(3),C(O(10,8,n.mastery||0,"1.0-1")),s(3),C(n.points||0)}}function It(e,t){e&1&&(o(0,"details",14)(1,"summary"),a(2,"Show History"),i(),o(3,"table",15)(4,"thead")(5,"tr")(6,"th"),a(7,"Session"),i(),o(8,"th"),a(9,"Date"),i(),o(10,"th"),a(11,"Eff%"),i(),o(12,"th"),a(13,"Mastery%"),i(),o(14,"th"),a(15,"Points"),i()()(),o(16,"tbody"),G(17,jt,13,11,"tr",null,lt),i()()()),e&2&&(s(17),z(t.worstPractice.history))}function wt(e,t){if(e&1){let n=q();o(0,"div",3)(1,"button",4),K("click",function(){Q(n);let l=L(2);return W(l.goHome())}),a(2,"Home"),i()(),o(3,"div",5)(4,"div",6)(5,"h3"),a(6,"Activity Heatmap"),i(),_(7,ut,1,1,"echarts",7)(8,ft,2,0,"p",8),i(),o(9,"div",9)(10,"h3"),a(11,"Total Points Progression"),i(),_(12,_t,1,1,"echarts",10),i(),o(13,"div",9)(14,"h3"),a(15,"Passed Subjects"),i(),_(16,bt,2,2,"div",11),o(17,"p",12),a(18,"A subject is counted as passed if any session granted points."),i()(),o(19,"div",9)(20,"h3"),a(21,"Avg Best Efficiency"),i(),_(22,ht,1,1,"echarts",13)(23,Ct,2,0,"p",8),i(),o(24,"div",9)(25,"h3"),a(26,"Avg Best Mastery"),i(),_(27,yt,1,1,"echarts",13)(28,St,2,0,"p",8),i(),o(29,"div",6)(30,"h3"),a(31,"Random Practice Sessions"),i(),_(32,xt,3,4,"p"),_(33,vt,1,1,"echarts",10),_(34,Mt,19,0,"details",14),i(),o(35,"div",6)(36,"h3"),a(37,"Worst Practice Sessions"),i(),_(38,Et,3,4,"p"),_(39,Ot,1,1,"echarts",10),_(40,It,19,0,"details",14),i()()}if(e&2){let n,r,l,g,u,p,j,c,h,x,m,d=L(2);s(7),b((n=d.heatmapOption())?7:8,n),s(5),b((r=d.pointsLineOption())?12:-1,r),s(4),b((l=d.data())?16:-1,l),s(6),b((g=d.avgBestEfficiencyGauge())?22:23,g),s(5),b((u=d.avgBestMasteryGauge())?27:28,u),s(5),b((p=d.data())?32:-1,p),s(),b((j=d.randomPracticeLine())?33:-1,j),s(),b((c=d.data())?34:-1,c),s(4),b((h=d.data())?38:-1,h),s(),b((x=d.worstPracticeLine())?39:-1,x),s(),b((m=d.data())?40:-1,m)}}function At(e,t){if(e&1&&(o(0,"div",2),a(1),i()),e&2){let n=L(2);s(),C(n.errorMessage())}}function Lt(e,t){if(e&1&&_(0,wt,41,11)(1,At,2,1,"div",2),e&2){let n=L();b(n.errorMessage()?1:0)}}function Bt(e,t){e&1&&(o(0,"div",1),a(1,"Loading statistics..."),i())}var ct=class e{constructor(t,n,r,l){this.stats=t;this.auth=n;this.content=r;this.router=l}loading=f(!0);errorMessage=f(null);data=f(null);sections=f([]);subjects=Y(()=>{let t=this.selectedSectionId();return this.sections().find(n=>n.id===t)?.subjects||[]});selectedSectionId=f(null);selectedSubjectId=f(null);subjectLineOption=f(null);heatmapOption=f(null);pointsLineOption=f(null);avgBestEfficiencyGauge=f(null);avgBestMasteryGauge=f(null);randomPracticeLine=f(null);worstPracticeLine=f(null);ngOnInit(){return R(this,null,function*(){try{let t=yield N(this.auth.authState());if(!t){this.errorMessage.set("Not authenticated");return}let n=yield N(this.content.getAllSections());this.sections.set(n),n.length&&(this.selectedSectionId.set(n[0].id),n[0].subjects.length&&this.selectedSubjectId.set(n[0].subjects[0].id)),this.stats.getAggregated(t.uid).subscribe({next:r=>{this.data.set(r),this.buildCharts(),this.loading.set(!1)},error:r=>{this.errorMessage.set(r.message||"Failed loading stats"),this.loading.set(!1)}})}catch(t){this.errorMessage.set(t.message||"Failed initializing stats"),this.loading.set(!1)}})}onSubjectChange(){this.buildSubjectPerformanceLine()}buildCharts(){this.buildSubjectPerformanceLine(),this.buildHeatmap(),this.buildPointsProgression(),this.buildAverageBestGauges(),this.buildPracticeLines()}buildSubjectPerformanceLine(){let t=this.data();if(!t)return;let n=this.selectedSubjectId();if(!n){this.subjectLineOption.set(null);return}let r=t.subjectPerformances.filter(p=>p.subjectId===n&&typeof p.mastery=="number"&&typeof p.efficiency=="number").sort((p,j)=>new Date(p.startedAt).getTime()-new Date(j.startedAt).getTime());if(!r.length){this.subjectLineOption.set(null);return}let l=r.map(p=>p.sessionId.substring(0,6)),g=r.map(p=>p.mastery),u=r.map(p=>p.efficiency);this.subjectLineOption.set({tooltip:{trigger:"axis"},legend:{data:["Mastery","Efficiency"],textStyle:{color:"#a9c0cf"}},grid:{left:40,right:20,top:30,bottom:30},xAxis:{type:"category",data:l,axisLabel:{color:"#6e8797"}},yAxis:{type:"value",min:0,max:100,axisLabel:{color:"#6e8797"}},series:[{name:"Mastery",type:"line",data:g,smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:3,color:"#5ac8fa"},itemStyle:{color:"#5ac8fa"}},{name:"Efficiency",type:"line",data:u,smooth:!0,symbol:"diamond",symbolSize:6,lineStyle:{width:3,color:"#f5d90a"},itemStyle:{color:"#f5d90a"}}]})}buildHeatmap(){let t=this.data();if(!t)return;if(!t.heatmap.length){this.heatmapOption.set(null);return}let n=t.heatmap.map(u=>[u.date,u.count]),r=t.heatmap.map(u=>u.date).sort(),l=r[0],g=r[r.length-1];this.heatmapOption.set({tooltip:{position:"top"},visualMap:{min:0,max:Math.max(...t.heatmap.map(u=>u.count)),orient:"horizontal",left:"center",bottom:0,textStyle:{color:"#a9c0cf"}},calendar:{range:[l,g],cellSize:[16,16],itemStyle:{borderWidth:0},splitLine:{show:!1},yearLabel:{show:!1},monthLabel:{color:"#6e8797"},dayLabel:{color:"#6e8797"}},series:[{type:"heatmap",coordinateSystem:"calendar",data:n}]})}buildPointsProgression(){let t=this.data();if(!t)return;let n=t.pointsProgression,r=n.map(l=>new Date(l.timestamp).toISOString().substring(5,10));this.pointsLineOption.set({tooltip:{trigger:"axis"},xAxis:{type:"category",data:r,axisLabel:{color:"#6e8797"}},yAxis:{type:"value",axisLabel:{color:"#6e8797"}},grid:{left:40,right:20,top:20,bottom:30},series:[{type:"line",data:n.map(l=>l.totalPoints),areaStyle:{}}]})}buildAverageBestGauges(){let t=this.data();if(!t)return;let n=(r,l)=>({series:[{type:"gauge",startAngle:210,endAngle:-30,progress:{show:!0,width:12},axisLine:{lineStyle:{width:12,color:[[1,"#244654"]]}},pointer:{show:!1},splitLine:{show:!1},axisTick:{show:!1},axisLabel:{show:!1},detail:{valueAnimation:!0,formatter:g=>`${g.toFixed(1)}%`,color:"#a9c0cf",fontSize:16},data:[{value:r,name:l}]}]});this.avgBestEfficiencyGauge.set(n(t.averageBest.avgBestEfficiency,"Efficiency")),this.avgBestMasteryGauge.set(n(t.averageBest.avgBestMastery,"Mastery"))}buildPracticeLines(){let t=this.data();if(!t)return;let n=r=>{let l=r.history.map(g=>g.sessionId.substring(0,6));return{tooltip:{trigger:"axis"},xAxis:{type:"category",data:l,axisLabel:{color:"#6e8797"}},yAxis:{type:"value",min:0,max:100,axisLabel:{color:"#6e8797"}},grid:{left:40,right:20,top:20,bottom:30},series:[{type:"line",data:r.history.map(g=>g.efficiency||0),smooth:!0}]}};this.randomPracticeLine.set(n(t.randomPractice)),this.worstPracticeLine.set(n(t.worstPractice))}goHome(){this.router.navigate(["/"])}static \u0275fac=function(n){return new(n||e)(A(T),A(ot),A(D),A(it))};static \u0275cmp=J({type:e,selectors:[["app-stats"]],decls:3,vars:1,consts:[[1,"stats-page"],[1,"loading"],[1,"error"],[2,"display","flex","justify-content","flex-end","margin-bottom",".75rem"],[1,"back-btn",3,"click"],[1,"grid"],[1,"panel","span-2-cols"],[1,"heatmap",3,"options"],[1,"empty"],[1,"panel"],[1,"chart",3,"options"],[1,"big-number"],[1,"small-note"],[1,"gauge",3,"options"],[1,"history"],[1,"compact"]],template:function(n,r){n&1&&(o(0,"div",0),_(1,Lt,2,1)(2,Bt,2,0,"div",1),i()),n&2&&(s(),b(r.loading()?2:1))},dependencies:[tt,nt,et,rt,Z],styles:[".stats-page[_ngcontent-%COMP%]{padding:1rem}.selectors[_ngcontent-%COMP%]{display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}.selectors[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{background:#12232c;color:#fff;border:1px solid #244654;padding:4px 8px;border-radius:4px}.grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr;gap:16px;align-items:start}@media (min-width: 900px){.grid[_ngcontent-%COMP%]{grid-template-columns:1fr 1fr}}.panel[_ngcontent-%COMP%]{background:var(--background-blue);border-radius:12px;padding:12px 16px;box-shadow:0 2px 4px #00000040;display:flex;flex-direction:column}.panel[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 8px;font-size:.95rem;letter-spacing:.5px;color:#a9c0cf;font-weight:600}.span-2[_ngcontent-%COMP%]{grid-column:span 2}.span-2-cols[_ngcontent-%COMP%]{grid-column:1 / -1}.chart[_ngcontent-%COMP%], .gauge[_ngcontent-%COMP%], .heatmap[_ngcontent-%COMP%]{width:100%;height:220px}.chart.tall[_ngcontent-%COMP%]{height:300px}.big-number[_ngcontent-%COMP%]{font-size:2.2rem;font-weight:700;color:var(--electric-blue);text-align:center}.small-note[_ngcontent-%COMP%]{font-size:.7rem;opacity:.7;text-align:center}.compact[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:.7rem;margin-top:8px}.compact[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .compact[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:4px 6px;border-bottom:1px solid #244654;text-align:left}.compact[_ngcontent-%COMP%]   tr.dim[_ngcontent-%COMP%]{opacity:.35}.compact.scrollable[_ngcontent-%COMP%], .panel[_ngcontent-%COMP%]   table.compact[_ngcontent-%COMP%]{max-height:600px;overflow:auto;display:block}.compact.scrollable[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%], .panel[_ngcontent-%COMP%]   table.compact[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{position:sticky;top:0;background:var(--background-blue);z-index:2}.compact.scrollable[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%], .panel[_ngcontent-%COMP%]   table.compact[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%], .compact.scrollable[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%], .panel[_ngcontent-%COMP%]   table.compact[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{display:table;width:100%;table-layout:fixed}.compact.scrollable[_ngcontent-%COMP%]::-webkit-scrollbar{width:8px}.compact.scrollable[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#2d4b5a;border-radius:4px}@supports (overflow: clip){.compact.scrollable[_ngcontent-%COMP%]{overflow:auto}}.empty[_ngcontent-%COMP%]{font-size:.75rem;opacity:.7}.history[_ngcontent-%COMP%]   summary[_ngcontent-%COMP%]{cursor:pointer;margin:6px 0;font-weight:600;letter-spacing:.5px}.loading[_ngcontent-%COMP%], .error[_ngcontent-%COMP%]{padding:2rem;text-align:center}.error[_ngcontent-%COMP%]{color:#e07d7d}.back-btn[_ngcontent-%COMP%]{background:var(--dark-blue);color:var(--white);border:1px solid #244654;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:.75rem;letter-spacing:.5px;transition:background .2s,color .2s}.back-btn[_ngcontent-%COMP%]:hover{background:var(--electric-blue);color:var(--dark-blue)}@media (min-width: 1200px){.chart[_ngcontent-%COMP%], .heatmap[_ngcontent-%COMP%]{height:260px}}"]})};export{ct as StatsComponent};
